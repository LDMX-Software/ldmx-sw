
name: Recon Validation

on: 
  pull_request: 
    branches: [trunk]
    #types: [opened, ready_for_review]

jobs:
  compile-ldmx-sw:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout ldmx-sw
      uses: actions/checkout@v2
      with:
        submodules: 'recursive'

    - name: Compile and Install ldmx-sw
      uses: ./.github/actions/setup
      with:
        image: ldmx/dev:latest

    - name: Package ldmx-sw Into Artifact
      run: tar -cvf ldmx-sw-package.tar install/

    - name: Upload ldmx-sw Package
      uses: actions/upload-artifact@v2
      with:
        name: ldmx-sw Build ${{ github.sha }}
        path: ldmx-sw-package.tar

  inclusive:
    needs: compile-ldmx-sw
    runs-on: ubuntu-latest
    steps:
    - name: Checkout ldmx-sw
      uses: actions/checkout@v2
      with:
        submodules: 'recursive'

    - name: Download ldmx-sw Package
      uses: actions/download-artifact@v2
      with:
        name: ldmx-sw Build ${{ github.sha }}

    - name: Unpack ldmx-sw Build
      run: tar xvf ldmx-sw-package.tar

    - name: Run Config
      uses: ./.github/actions/ldmx
      with:
        image: ldmx/dev:latest
        working_dir: ldmx-sw/.github/workflows
        run: fire configs/inclusive.py

    - name: Upload Inclusive Events for Overlay
      uses: actions/upload-artifact@v2
      with:
        name: Inclusive Overlay Events ${{ github.sha }}
        path: .github/workflows/events/inclusive.root

    - name: Cache the Gold
      id: gold-cache
      uses: actions/cache@v2
      with:
        path: ldmx-sw/.github/workflows/gold/inclusive.root
        key: inclusive-gold

    - name: Generate Gold
      if: steps.gold-cache.outputs.cache-hit != 'true'
      uses: ./.github/actions/generate-gold
      with:
        config: configs/inclusive.py

    - name: Compare to Golden Histograms
      uses: ./.github/actions/ldmx
      with:
        image: ldmx/dev:latest
        working_dir: ldmx-sw/.github/workflows
        run: python3 compare.py inclusive

    - name: Upload Validation Plots
      uses: actions/upload-artifact@v2
      with:
        name: Inclusive Recon Validation ${{ github.sha }}
        path: .github/workflows/plots/**

    - name: Check if Failed
      uses: ./.github/actions/check
      with:
        sample_id: inclusive

  ecal_pn:
    needs: compile-ldmx-sw
    runs-on: ubuntu-latest
    steps:
    - name: Checkout ldmx-sw
      uses: actions/checkout@v2
      with:
        submodules: 'recursive'

    - name: Download ldmx-sw Package
      uses: actions/download-artifact@v2
      with:
        name: ldmx-sw Build ${{ github.sha }}

    - name: Unpack ldmx-sw Build
      run: tar xvf ldmx-sw-package.tar

    - name: Run Config
      uses: ./.github/actions/ldmx
      with:
        image: ldmx/dev:latest
        working_dir: ldmx-sw/.github/workflows
        run: fire configs/ecal_pn.py

    - name: Cache the Gold
      id: gold-cache
      uses: actions/cache@v2
      with:
        path: ldmx-sw/.github/workflows/gold/inclusive.root
        key: inclusive-gold

    - name: Generate Gold
      if: steps.gold-cache.outputs.cache-hit != 'true'
      uses: ./.github/actions/generate-gold
      with:
        config: configs/inclusive.py

    - name: Compare to Golden Histograms
      if: ${{ github.event_name == 'pull_request' }}
      uses: ./.github/actions/ldmx
      with:
        image: ldmx/dev:latest
        working_dir: ldmx-sw/.github/workflows
        run: python3 compare.py ecal_pn

    - name: Upload Validation Plots
      if: ${{ github.event_name == 'pull_request' }}
      uses: actions/upload-artifact@v2
      with:
        name: ECal PN Recon Validation ${{ github.sha }}
        path: .github/workflows/plots/**

    - name: Check if we Failed
      if: ${{ github.event_name == 'pull_request' }}
      uses: ./.github/actions/check
      with:
        sample_id: ecal_pn
