
name: Generate Golden Histograms

# Manually launch this action via GitHub
on: 
  workflow_dispatch:
    inputs:
      label:
        description: 'Human-Readable Short Label for this Set of Histograms'
        required: true
        default: 'golden'
  release:

jobs:
  physics-validation:
    runs-on: ubuntu-latest
    env:
      image: ldmx/dev:latest #define image to rbuild ldmx-sw and run tests on
    defaults:
      run:
        shell: bash

    steps:
    # check out ldmx-sw in the workspace
    - uses: actions/checkout@v2
      with:
        submodules: 'recursive'

    # Setup our ldmx development environment
    - name: Setup ldmx environment
      run: docker pull ldmx/dev:latest
    
    # configure ldmx-sw using the docker environment
    - name: Configure the build
      run: |
          mkdir build &&
          docker run -i -v $(pwd):$(pwd) ${image} $(pwd)/build cmake ..

    # build ldmx-sw using the docker environment
    - name: Build and Install
      run: docker run -i -v $(pwd):$(pwd) ${image} $(pwd)/build make install

    # Run the test using ctest. The --verbose parameter displays the output 
    # you would typically see with catch.
    - name: Test the build
      run: |
          cd ../ &&
          export LDMX_BASE=$(pwd) &&
          docker run -i -e LDMX_BASE -v $(pwd):$(pwd) ${image} $LDMX_BASE/ldmx-sw/build ctest --verbose 

    # Deduce label for this set of golden histograms
    - name: Deduce Gold Label
      id: deduce_label
      run: |
        _label=${{ github.event.inputs.label }}
        if [[ -z ${_label} ]]; then
          _label=${GITHUB_REF#refs/tags/}
        fi
        echo "Deduced label: ${_label}"
        echo ::set-output name=label::${_label}

    # Actually run generation script
    - name: Generate Golden Histograms
      run: bash .github/workflows/run_physics.sh gen ${{ steps.deduce_label.outputs.label }}

    # Push newly generated files
    - name: Push Histograms
      run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .github/workflows/gold/*
          git commit -m "New set of golden histograms labled ${{ steps.deduce_label.outputs.label }}"
          git push
