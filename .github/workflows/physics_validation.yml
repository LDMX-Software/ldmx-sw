
name: Physics Validation

# Manually launch this action via GitHub
on: 
  workflow_dispatch:
    inputs:
      golden:
        description: 'Git Reference to Retrieve Golden Files From'
        required: true
        default: 'trunk'
  pull_request: 
    branches: [trunk]
    types: [opened, ready_for_review]
  #include pushes to this branch for testing
  push:
    branches: [iss988-validation-action]

jobs:
  compile-ldmx-sw:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout ldmx-sw
      uses: actions/checkout@v2
      with:
        submodules: 'recursive'

    - name: Compile and Install ldmx-sw
      uses: ./.github/actions/setup
      with:
        image: ldmx/dev:latest

    # Checkout the branch that has the "golden files" if they are different
    # than the ones stored on our branch. By default, we get the files from
    # 'trunk', but this action can be re-run where the branch/tag/sha is manually
    # input.
    - name: Git Golden Files
      uses: actions/checkout@v2
      if: ${{ github.event.event_name == 'workflow_dispatch' }}
      with:
        ref: ${{ github.event.input.golden }}
        submodules: 'recursive'

    - name: Upload ldmx-sw Package for Later Jobs
      uses: actions/upload-artifact@v2
      with:
        name: ldmx-sw-package
        path: |
          install/**
          .github/workflows/gold/**

  inclusive:
    needs: compile-ldmx-sw
    runs-on: ubuntu-latest
    steps:
    - name: Get Compiled ldmx-sw
      uses: actions/download-artifact@v2
      with:
        name: ldmx-sw-package

    - name: Deduce Labels for Plots
      id: deduce_labels
      run: |
        _test_label=${GITHUB_REF#refs/}
        _test_label=${_test_label#tags/}
        _test_label=${_test_label#heads/}
        _gold_label=$(cat .github/workflows/gold/label)
        echo "Test Label: ${_test_label}"
        echo "Gold Label: ${_gold_label}"
        echo ::set-output name=test::${_test_label}
        echo ::set-output name=gold::${_gold_label}
      shell: bash

    - name: Physics Validation
      uses: ./.github/actions/ldmx
      with:
        image: ldmx/dev:latest
        working_dir: ldmx-sw/.github/workflows
        run: 'python3 physics.py val configs/inclusive.py ${{ steps.deduces_labels.outputs.test }} ${{ steps.deduce_labels.outputs.gold }}'

    - name: Upload Validation Plots
      uses: actions/upload-artifact@v2
      with:
        name: Physics Validation
        path: .github/workflows/plots/**

